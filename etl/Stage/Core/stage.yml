version: 2

models:
  - name: epic_registry_info
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [epic_registry_id]
  - name: epic_registry_membership_history
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [epic_registry_hx_key]
  - name: stg_adt_all
    columns:
      - name: intended_use_group
        tests:
          - relationships:
              to: source('cdw_analytics','fact_department_rollup')
              field: intended_use_dept_grp_abbr
      - name: department_name
        tests:
          - relationships:
              to: source('cdw','department')
              field: dept_nm
      - name: visit_event_key
        tests:
          - relationships:
              to: source('cdw','visit_event')
              field: visit_event_key
      - name: dept_key
        tests:
          - relationships:
              to: source('cdw','department')
              field: dept_key
      - name: department_group_name
        tests:
          - dbt_utils.relationships_where:
              to: source('cdw_analytics','fact_department_rollup')
              field: unit_dept_grp_abbr
              from_condition: intended_use_group = 'IP'
  - name: stg_patient
    columns:
      - name: pat_key
        tests:
          - relationships:
              to: source('cdw','patient')
              field: pat_key
              warn_if: ">0"
              error_if: ">238"
      - name: patient_name
        tests:
          - not_null
      - name: dob
        tests:
          - dbt_chop_utils.date_in_past
          - not_null:
              severity: warn
      - name: mrn
        tests:
          - not_null
          - dbt_chop_utils.number_of_characters:
              min_length: 8
              condition: lower(mrn) not in ('invalid', 'unknown')
              severity: warn
  - name: stg_encounter
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_key]
      - dbt_chop_utils.recency:
          column_name: encounter_date
          datepart: days
          interval: 2
          tags: ['failing']
    columns:
      - name: visit_key
        tests:
          - relationships:
              to: source('cdw','visit')
              field: visit_key
      - name: csn
        tests:
          - dbt_chop_utils.number_of_characters:
              min_length: 14
              severity: warn
      - name: encounter_date
        tests:
          - not_null
      - name: age_years
        tests:
          - dbt_chop_utils.within_range:
              min_value: 0
              max_value: 200
              severity: warn
          - dbt_chop_utils.not_null_when:
              expression: age_days is not null
  - name: stg_encounter_payor
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_key]
  - name: stg_telehealth_encounter_provider
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_provider_seq_key]
  - name: stg_adt_treatment_team
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_event_key]
  - name: stg_treatment_teams
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_key]
  - name: stg_provider_encounter_care_team
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [csn, provider_care_team_name, provider_care_team_start_date]
          tags: ['failing']
    columns:
      - name: provider_care_team_name
      - name: provider_care_team_group_name
  - name: stg_redcap_porter_value_label
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [project_id, field_name, element_id]
          tags: ['failing']
  - name: stg_gps_healthcloud
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [patient_enroll_date_key]
  - name: stg_encounter_gps
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [visit_key]
  - name: stg_department_all
    columns:
      - name: intended_use_id
        tests:
          - not_null:
              severity: warn
      - name: intended_use_name
        tests:
          - not_null:
              severity: warn
  - name: stg_encounter_form_answer
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [encounter_key, question_answer_seq_num, encounter_seq_num]
  - name: stg_note_info
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [stg_note_info_key]
  - name: stg_note_text
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [stg_note_text_line_key]
  - name: stg_note_visit_info
    tests:
      - dbt_chop_utils.is_primary_key:
          column_names: [stg_note_visit_info_key]
