WITH CATH_STUDY AS
(SELECT STUDY.REFNO, 
        STUDY.ADMISSID, 
		CAST(V1.ENC_ID AS INT)  SURG_ENC_ID,
		STUDY.ACCESSNO,
		STUDY.ORDNUM,
        STUDATE,
		SH_ACC_TM,
		POCT.PREND,
		PATIENT_MATCH.PAT_KEY, 
		PAT_MRN_ID,
		PD.HEIGHT,
		PD.WEIGHT  --SELECT *
FROM SENSIS_STUDY STUDY JOIN CDWUAT..PATIENT_MATCH ON STUDY.REFNO = PATIENT_MATCH.SRC_SYS_ID AND SRC_SYS_NM = 'SENSIS'
                                     JOIN CDWUAT..PATIENT ON PATIENT.PAT_KEY = PATIENT_MATCH.PAT_KEY
									 JOIN SENSIS_CT CT ON STUDY.REFNO = CT.REFNO
									 JOIN CDWUAT..PROCEDURE_ORDER PO ON PO.PROC_ORD_ID = STUDY.ORDNUM
									 JOIN CDWUAT..OR_CASE_ORDER OCO ON OCO.ORD_KEY = PO.PROC_ORD_KEY
									 JOIN CDWUAT..OR_LOG ON OR_LOG.CASE_KEY = OCO.OR_CASE_KEY
									 JOIN CDWUAT..VISIT V1 ON V1.VISIT_KEY = OR_LOG.VISIT_KEY
									 --JOIN VISIT V2 ON V2.VISIT_KEY = OR_LOG.ADMIT_VISIT_KEY
									 LEFT JOIN SENSIS_PD PD ON STUDY.REFNO = PD.REFNO
									 LEFT JOIN (SELECT REFNO, MIN(SHTIME) SH_ACC_TM FROM SENSIS_ASR GROUP BY REFNO) SHEATH ON STUDY.REFNO = SHEATH.REFNO
									 LEFT JOIN SENSIS_POCT POCT ON STUDY.REFNO = POCT.REFNO 
WHERE POCT.PRTYPE <> 10 --Fluoro
)
  

    select
		SURG_ENC_ID
        ,CASE WHEN TPV2IND.TPVRCI = 1 THEN 4110
		      WHEN TPV2IND.TPVRCI = 2 THEN 4111
			  WHEN TPV2IND.TPVRCI = 3 THEN 4112
			  WHEN TPV2IND.TPVRCI = 4 THEN 4113
			  WHEN TPV2IND.TPVRCI = 5 THEN 4114
		ELSE NULL END AS TPVRCLININD
		,CASE WHEN TPV2IND.TPVRHI = 1 THEN 4132
		      WHEN TPV2IND.TPVRHI = 2 THEN 4133
			  WHEN TPV2IND.TPVRHI = 3 THEN 4134
		ELSE NULL END AS TPVRHEMOIND
		,CASE WHEN TPV2IND.I11010 = 1 THEN 4144
		      WHEN TPV2IND.I11010 = 2 THEN 4146
			  WHEN TPV2IND.I11010 = 3 THEN 4148
			  WHEN TPV2IND.I11010 = 4 THEN 4149
			  WHEN TPV2IND.I11010 = 5 THEN 4145
			  WHEN TPV2IND.I11010 = 6 THEN 4147
        ELSE NULL END AS TPVRRVOTDYSFUNCTION
		,IP2PPT.I11015 TPVRECHO
		,CAST(IP2PPT.I11016 AS NUMERIC(4,1)) TPVRECHOMEANGRADIENT
		,CAST(IP2PPT.I11017 AS NUMERIC(4,1)) TPVRECHOMAXGRADIENT
		,CASE WHEN IP2PPT.I11018 = 0 THEN 4122
		      WHEN IP2PPT.I11018 = 1 THEN 4123
			  WHEN IP2PPT.I11018 = 2 THEN 4124
			  WHEN IP2PPT.I11018 = 3 THEN 4125
			  WHEN IP2PPT.I11018 = 4 THEN 4126
		 ELSE NULL END AS TPVRECHOPVREGURG
        ,IP2PPT.I11019 TPVRECHOLVEF
		,CASE WHEN IP2PPT.I11020 = 0 THEN 4127
		      WHEN IP2PPT.I11020 = 1 THEN 4128
			  WHEN IP2PPT.I11020 = 2 THEN 4129
			  WHEN IP2PPT.I11020 = 3 THEN 4130
			  WHEN IP2PPT.I11020 = 4 THEN 4131
		 ELSE NULL END AS TPVRECHOTRS
		,IP2PPT.I11030 TPVRMRI
		,IP2PPT.I11031 TPVRMRIRVEF
		,IP2PPT.I11032 TPVRMRILVEF
		,IP2PPT.I11033 TPVRMRIRVEDVINDEX
		,IP2PPT.I11034 TPVRMRIRVESVINDEX
		,IP2PPT.I11035 TPVRMRILVEDVINDEX
		,IP2PPT.I11036 TPVRMRILVESVINDEX
		,IP2PPT.I11037 TPVRMRIPRFRACTION
		,CASE WHEN IP2RVOT.IP2RVOT = 76 THEN 4150
		      WHEN IP2RVOT.IP2RVOT = 77 THEN 4154
			  WHEN IP2RVOT.IP2RVOT = 78 THEN 4155
			  WHEN IP2RVOT.IP2RVOT = 79 THEN 4156
			  WHEN IP2RVOT.IP2RVOT = 80 THEN 4151
			  WHEN IP2RVOT.IP2RVOT = 81 THEN 4152
			  WHEN IP2RVOT.IP2RVOT = 82 THEN 4153
		ELSE NULL END AS TPVRRVOTTYPE 
		,IP2RVOT.I11041 TPVRORIGINALCONDUIT
		,IP2RVOT.I11045 TPVREXISTINGSTENT
		,IP2RVOT.I11050 TPVRPRIORTPVR
		,CAST(IP2RVOT.I11055 AS NUMERIC(5,2)) TPVRCATHPEAKGRADIENT
		,CAST(IP2RVOT.I11060 AS NUMERIC(5,2)) TPVRNARROWDIA
		,IP2CART.I11065 TPVRAORTOPERF 
		,IP2CART.I11070 TPVRSELECTIVEANGIO
		,IP2CART.I11075 TPVRCORCOMPRESSTEST
		,CAST(IP2CART.I11076 AS NUMERIC(4,1)) TPVRMAXBALLOONSIZE
		,CASE WHEN IP2CART.I11077 = 1 THEN 4116
		      WHEN IP2CART.I11077 = 2 THEN 4115
			  WHEN IP2CART.I11077 = 3 THEN 4117
		 ELSE NULL END AS TPVRCORCOMPRESSPRESENT
		,IP2INT.I11080 TPVRPREDILATIONPERF
		,CAST(IP2INT.I11081 AS NUMERIC(4,1)) TPVRFIRSTBALLSIZE
		,CAST(IP2INT.I11082 AS NUMERIC(4,1)) TPVRMAXBALLSIZE
		,IP2INT.I11083 TPVRHIGHINFLAPERF
		,IP2INT.I11085 TPVRNEWPRESTENT
		,IP2INT.I11086 TPVRNEWSTENTSNUM
		,CASE WHEN IP2INT.I11090 = 1 THEN 4105
		      WHEN IP2INT.I11090 = 2 THEN 4106
			  WHEN IP2INT.I11090 = 3 THEN 4107
			  WHEN IP2INT.I11090 = 4 THEN 4108
			  WHEN IP2INT.I11090 = 5 THEN 4109
		 ELSE NULL END AS TPVRACCESSVESSEL 
		,CAST(IP2INT.I11095 AS NUMERIC(4,1)) TPVRDELIBALLSIZE
		,IP2INT.I11100 TPVRTPVDEPLOYED
		,IP2INT.I11101 TPVRTPVPOSTDILATION
		,CAST(IP2INT.I11102 AS NUMERIC(4,1)) TPVRFINALBALLSIZE
		,IP2INT.I11103 TPVRFINALPRESSURE
		,CAST(IP2INT.I11105 AS NUMERIC(4,1)) TPVRPEAKRVOTGRAD
		,CASE WHEN IP2INT.I11110 = 0 THEN 4122
		      WHEN IP2INT.I11110 = 1 THEN 4123 
			  WHEN IP2INT.I11110 = 2 THEN 4124 
			  WHEN IP2INT.I11110 = 3 THEN 4125 
			  WHEN IP2INT.I11110 = 4 THEN 4126 
		 ELSE NULL END AS TPVRPOSTPROCPVREGURG --CODE 
		,CAST(IP2INT.I11115 AS NUMERIC(5,2)) TPVRFINALDIAMETER
		,IP2INT.I11120 TPVRNOTDEPLOYEDREASON -- ALL NULLS
		,null TPVRPOSTECHO -- CODES?
		,CAST(null AS NUMERIC(5,2)) TPVRPOSTECHOMEANGRAD
		,CAST(null AS NUMERIC(5,2)) TPVRPOSTECHOMAXGRAD
		,null TPVRPOSTECHOPULVALVERGURG --CODES
		
  FROM CATH_STUDY STUDY 
                         JOIN SENSIS_TPV2IND TPV2IND ON STUDY.REFNO = TPV2IND.REFNO
                         JOIN SENSIS_IP2PPT IP2PPT ON STUDY.REFNO = IP2PPT.REFNO
						 JOIN SENSIS_IP2RVOT IP2RVOT ON STUDY.REFNO = IP2RVOT.REFNO
						 JOIN SENSIS_IP2CART IP2CART ON STUDY.REFNO = IP2CART.REFNO
						 JOIN SENSIS_IP2INT IP2INT ON STUDY.REFNO = IP2INT.REFNO